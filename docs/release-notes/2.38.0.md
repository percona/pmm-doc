# Percona Monitoring and Management 2.38.0

| **Release date:** | Jun 23, 2023                                                                                    |
| ----------------- | ----------------------------------------------------------------------------------------------- |
| **Installation:** | [Installing Percona Monitoring and Management](https://www.percona.com/software/pmm/quickstart) |

Percona Monitoring and Management (PMM) is an open-source database monitoring, management, and observability solution for MySQL, PostgreSQL, and MongoDB.

<!---
!!! caution alert alert-warning "Important/Caution"
    Crucial points that need emphasis:

    - Important: A significant point that deserves emphasis.
    - Caution: Used to mean 'Continue with care'.
 --->


## Release Highlights

### Important security updates

**Oracle Linux 9 as base OS for PMM**

As security is paramount to us, starting with PMM 2.38.0, we have laid a solid and modernized enterprise-grade foundation for PMM. We have migrated our base operating system on which we build our base image from CentOS 7 to Oracle Linux 9. Thus starting with PMM 2.38.0, we have made PMM publicly available on Oracle Linux 9.

There are many benefits of this transition. The migration fixes a large number of CVEs and will see improved upstream response time to security-related issues. It also uses more modern libraries for our team to build on long with better compatibility with new technologies. 

We will be rolling this out in phases.

The following users will be able to take advantage of this immediately:

*New installations of PMM* 

- New installations will pull down the Oracle Linux 9 container by default
- Existing users that upgrade PMM using a full container replacement method will also pull the Oracle Linux 9 
- Fresh AMI installations
- Fresh OVF installations

*Users who will need to wait a bit longer*

Users that exclusively upgrade through the UI’s **Upgrade Now** button including:

- Docker users that use UI upgrade
- AMI users
- OVF users

**Grafana**

Grafana has been upgraded to 9.2.18 due to [CVE-2023-28119](https://github.com/advisories/GHSA-5mqj-xc49-246p) and [CVE-2023-1387](https://github.com/advisories/GHSA-c3h9-vpfv-3x4m).

**Exporters** 

Updated the mysqld_exporter, node_exporter, postgres_exporter, mongo_exporter to fix the CVEs.

**ClickHouse plugin**

We have migrated from the [Altinity Clickhouse datasource](https://grafana.com/grafana/plugins/vertamedia-clickhouse-datasource/) to the [Grafana Clickhouse datasource](https://grafana.com/grafana/plugins/grafana-clickhouse-datasource/) due to the vulnerabilities discovered. 

Due to this migration, we have also updated our experimental Environment Overview Dashboard.

!!! caution alert alert-warning "Important"
    Though we have removed the datasource from PMM, we are still reusing the same name (ClickHouse) to keep the changes minimal. Thus, if you are using the old datasource in your dashboards, ensure that you upgrade the underlying queries that will pull the data from the new datasource.
   
**Example**

The following example shows the difference in the query before and after migration:

Before migration:

    ```sh
    // Altinity ClickHouse datasource
    SELECT $timeSeries as t, 
        sum(m_query_time_sum)/sum(m_query_time_cnt) as QLatency,
        environment
    FROM $table
    WHERE $timeFilter and environment != ''
    GROUP BY t,environment
    ORDER BY t
    ```

After migration:

    ```sh
    // Grafana ClickHouse datasource
    SELECT period_start as t,
        sum(m_query_time_sum)/sum(m_query_time_cnt) as QLatency,
        environment
    FROM pmm."metrics" 
    WHERE $__timeFilter(period_start) AND environment != ''
    GROUP BY t, environment
    ORDER BY t
    ```    
Altinity data sources used macros like $timeSeries, $timeFilter, and $table, which are no longer present in the Grafana datasource. As a result, the query needs to be rewritten to use the new macros instead of the old ones. You will notice that in the example above, the macro `$timeFilter` has changed to `$__timeFilter`, and now it requires a parameter, which should be a column of type datetime.

Depending on which macros you have used, your migration effort will vary. However, we recommend checking the [plugin documentation](https://grafana.com/grafana/plugins/grafana-clickhouse-datasource/) to apply the new syntax correctly, including macros and template variables.

**CVEs**

Several CVEs have been fixed in PMM 2.38.0.

### Improved nodes view on the Inventory page

In our continuing endeavor to enhance user experience, we further improved the **Inventory** page by improving the **Nodes** tab. With this change, you can get more context on your inventory objects, such as node, and more actionable information for exploring and resolving possible issues.

Here is the change as part of PMM 2.38.0:

- Check the number of agents running on any particular node. When you click on any node, the UI navigates to the view of agents, which is filtered to display only agents related to that specific node.

    To see the details of the agents running:

    On the **Nodes** tab, under the **Monitoring** column, click **OK** or **Failed** depending on the status of the node that you have selected. A page that provides the user with crucial information regarding the total number of agents deployed on that node is displayed.
        ![!image](../_images/PMM_Inventory_Node_Agent_Properties.png)

- View comprehensive information about each agent, including key attributes such as node type, IP address, and associated services. This gives you a complete overview of the nodes at a glance.

    ![!image](../_images/PMM_Inventory_Node_Selection.png)

- Check the health status of the agents to see if they are running or have failed.

### Backup enhancements

#### Better folder management for enhanced PMB compatibility 

We’ve added a new **Folder** field to the Create Backup pages. Use this to set a specific target directory within the selected local or S3-compatible location for the backup.  

Organizing backups in folders makes grouping PBM backups for clusters easier, and it improves PMM-PBM (Percona Backup for MongoDB) integration workflows.

The **Folder** field is automatically populated with the value of the cluster label. You can change this default folder from PMM’s Advanced Settings, but make sure you understand how your custom folder will impact PBM integration workflows.


#### Sharded cluster MongoDB backup support

This release introduces support for working with backups for sharded clusters. PMM handles the backup process end-to-end, but restoring such artifacts is currently possible only via the CLI, using Percona Backup for MongoDB.

For information on restoring sharded backups, check the [PBM documentation](https://docs.percona.com/percona-backup-mongodb/usage/restore.html).

### SQL comments support in QAN

!!! caution alert alert-warning "Important/Caution"
    This feature is still in [Technical Preview](https://docs.percona.com/percona-monitoring-and-management/details/glossary.html#technical-preview) and is subject to change. We recommend that early adopters use this feature for testing purposes only.

You can now collect labels from the comments placed in SQL queries. You can tag the query by key value in the query comment. This helps in query management and optimization. This feature is currently supported for MySQL and PostgreSQL.


For example:

    ```sh
    SELECT * /* cluster=’east’ */ FROM city;   
    ```
You can enable this feature as follows:

CLI - Pass the parameter `comments-parsing`
UI - It is enabled by default. To disable, uncheck the **Disable comments parsing** checkbox in the **Additional Options** section. This is supported for PostgreSQL and MySQL.

![!image](../_images/PMM_QAN_Parsing.png)


### New PMM Agent Down alert template

We've added a new default alert template to [Percona Alerting](../get-started/alerting.md). 

The new **PMM Agent down** alert template monitors your Node status to notify if the Agent is down. Before using this template:

- ensure the PMM Agent is healthy and present on the Database Node.
-  check that PMM Client is on version 2.38 version or later.

![!image](../_images/Agent_down.png)

## New Features

- [PMM-2852](https://jira.percona.com/browse/PMM-2852) -   [QAN]: Starting with PMM 2.38.0, MySQL and PostgreSQL supports collection of labels from the comments placed in the SQL queries.
- [PMM-11961](https://jira.percona.com/browse/PMM-11961) - [Inventory]: Starting with PMM 2.38.0, we have enhanced the **Inventory** page by improving the **Nodes** tab. With this change, you can get more context on your inventory objects, such as node, and more actionable information for exploring and resolving possible issues.
- [PMM-11962](https://jira.percona.com/browse/PMM-11962) - [Inventory]: Starting with PMM 2.38.0, you can filter the nodes and services on the **Inventory** page using the parameters such as ID, names, status, etc., instead of scrolling through an exhaustive list of nodes or services.
- [PMM-12087](https://jira.percona.com/browse/PMM-12087) - [Inventory]: Added tooltips to explain the meaning of the different services statuses in the Inventory view.   

## Improvements

- [PMM-9367](https://jira.percona.com/browse/PMM-9367) -   [Backups]: Added support for working with backups for sharded clusters.
- [PMM-11250](https://jira.percona.com/browse/PMM-11250) - [Backup]: Added option to specify target directory for the selected backup location to improve PMM-PBM integration workflows.
- [PMM-12038](https://jira.percona.com/browse/PMM-12038) - [Backup]: Extended support for MongoDB backups to cover all authentication mechanisms available for MongoDB (including LDAP, x509 certs).
- [PMM-9544](https://jira.percona.com/browse/PMM-9544) -   [Alerting]: Added new default alert template to Node status and notify if the Agent is down.
- [PMM-12114](https://jira.percona.com/browse/PMM-12114) - Upgraded Grafana to 9.2.18 to fix to CVEs.
- [PMM-12136](https://jira.percona.com/browse/PMM-12136) - We have migrated our base operating system on which we build our base image from CentOS 7 to Oracle Linux 9 to fix the CVEs.

## Bugs Fixed

- [PMM-11578](https://jira.percona.com/browse/PMM-11578) - [Alerting]: The **Last notified** column under **Alerting > Fired Alerts** has been renamed to **Last triggered**. This better illustrates the fact that triggered alerts may not always generate a notification. This can happen when the contact points are not correctly configured.
In addition, the **Suppressed** status in the **State** column has been renamed to **Silenced** to keep consistency with how this status is displayed on other **Alerting** pages.
- [PMM-12067](https://jira.percona.com/browse/PMM-12067) - [QAN]: Fixed vulnerability in Vitess package.
- [PMM-12105](https://jira.percona.com/browse/PMM-12105) - [QAN]: Fixed an issue where QAN was broken due to wrong pgsm_query_ids.
- [PMM-10063](https://jira.percona.com/browse/PMM-10063) - [QAN]: The QAN filter section could display the available list of services/nodes. But the load time was too much, with the UI  being unresponsive. This issue has been resolved now. The entire list is loaded with the count displayed on the upper right side.
- [PMM-11386](https://jira.percona.com/browse/PMM-11386) - [QAN]: MongoDB QAN query time metrics was showing the wrong unit. It should be ms. The issue has been resolved now.
- [PMM-12024](https://jira.percona.com/browse/PMM-12024) - [QAN]: Fixed an issue where a QAN agent couldn't start due to an expected return value type.
- [PMM-12091](https://jira.percona.com/browse/PMM-12091) - [QAN]: The tooltip for QAN > MongoDB > Query Details was displayed in seconds instead of decimals. The issue has been fixed now.
- [PMM-9844](https://jira.percona.com/browse/PMM-9844) -   [QAN]: Data for a large number of partitions or possible indexes was shown in the QAN Details tab in one scrolling column making it practically impossible to read. The issue has been resolved now.
- [PMM-11938](https://jira.percona.com/browse/PMM-11938) - [QAN]: Fixed the problem when PMM tried to create `pg_stat_monitor_settings` view all over again.
- [PMM-12031](https://jira.percona.com/browse/PMM-12031) - [Inventory]: The `enhanced_metrics_disabled` and `basic_metrics_disabled` were not displayed on the **Inventory** page for an external service. The issue has been resolved now.
- [PMM-11645](https://jira.percona.com/browse/PMM-11645) - Fixed mysql service detection when this is not loaded in systemd.
- [PMM-9541](https://jira.percona.com/browse/PMM-9541) - PostgreSQL exporter not working with --socket
- [PMM-10799](https://jira.percona.com/browse/PMM-10799) - Now in the **EXPLAIN/TABLE** tab you can get results even for queries with table alias.
- [PMM-11692](https://jira.percona.com/browse/PMM-11692) - On the MySQL Instances Overview dashbaord, the`Top MySQL Active Client Threads` panel color was misleading. The issue has been resolved now.
- [PMM-11715](https://jira.percona.com/browse/PMM-11715) - CPU Utilization Graph for RDS instances was not matching what Cloudwatch reported. The issue has been resolved now.
- [PMM-11950](https://jira.percona.com/browse/PMM-11950) - Non-admin roles are calling restricted endpoints after login or page refresh.
- [PMM-12085](https://jira.percona.com/browse/PMM-12085) - Fixed an issue where SSH access to AMI and OVF images for Oracle Linux 9-based images did not work. The issue has been resolved now.
- [PMM-12118](https://jira.percona.com/browse/PMM-12118) - Addressed the Grafana ClickHouse DS plugin CVEs.
- [PMM-12119](https://jira.percona.com/browse/PMM-12119) - When a user successfully adds an RDS service to PMM, the RDS exporter's status does not change from "UNKNOWN" (the initial status of all exporters) to "RUNNING."  This issue has been resolved.

<!---


## Known issues

- ​List of known issues with a  comprehensive description and link to the JIRA ticket.

    Example:

    [PMM-XXXX](https://jira.percona.com/browse/PMM-XXXX) - Comprehensive description.


    **Solution**

    Description of the solution.


## Coming Soon

  Share what are the upcoming features on your roadmap to keep users excited:

- Planned item 1
- Planned item 2

--->
